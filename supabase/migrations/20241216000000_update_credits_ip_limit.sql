-- ==========================================
-- æ­¥éª¤ 0: åˆ›å»º IP ä½¿ç”¨è®°å½•è¡¨ (ä¿®å¤ missing relation é”™è¯¯)
-- ==========================================
CREATE TABLE IF NOT EXISTS public.ip_usage_logs (
    id bigint generated by default as identity primary key,
    client_ip text not null,
    usage_date date not null DEFAULT CURRENT_DATE,
    generation_count integer default 0,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    last_generation_at timestamp with time zone default timezone('utc'::text, now()),
    updated_at timestamp with time zone default timezone('utc'::text, now())
);

-- æ·»åŠ ç´¢å¼•ä»¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦
CREATE INDEX IF NOT EXISTS idx_ip_usage_logs_ip_date ON public.ip_usage_logs(client_ip, usage_date);

-- å¯ç”¨ RLS (è™½ç„¶æ­¤è¡¨ä¸»è¦ç”±æœåŠ¡ç«¯å‡½æ•°è¯»å†™ï¼Œä½†å¼€å¯æ˜¯å¥½ä¹ æƒ¯)
ALTER TABLE public.ip_usage_logs ENABLE ROW LEVEL SECURITY;

-- ==========================================
-- æ­¥éª¤ 1: å°†æ–°ç”¨æˆ·åˆå§‹ç§¯åˆ†è°ƒæ•´ä¸º 30
-- ==========================================
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  -- åˆ›å»º Customer è®°å½•
  INSERT INTO public.customers (
    user_id,
    email,
    credits,          -- ğŸŸ¢ ä¿®æ”¹ç‚¹ï¼šé»˜è®¤ 30 ç§¯åˆ†
    creem_customer_id,
    created_at,
    updated_at,
    metadata
  ) VALUES (
    NEW.id,
    NEW.email,
    30,               -- ğŸŸ¢ ä¿®æ”¹ç‚¹ï¼šé»˜è®¤ 30 ç§¯åˆ†
    'auto_' || NEW.id::text,
    NOW(),
    NOW(),
    jsonb_build_object(
      'source', 'auto_registration', 
      'initial_credits', 30,
      'provider', NEW.raw_user_meta_data->>'provider' -- è®°å½•æ˜¯ Google è¿˜æ˜¯ Email æ³¨å†Œ
    )
  );

  -- è®°å½•ç§¯åˆ†å†å²ï¼ˆè®©ç”¨æˆ·çŸ¥é“è¿™æ˜¯æ³¨å†Œé€çš„ï¼‰
  INSERT INTO public.credits_history (
    customer_id, 
    amount, 
    type, 
    description, 
    created_at
  ) VALUES (
    (SELECT id FROM public.customers WHERE user_id = NEW.id),
    30, 
    'add', 
    'ğŸ‰ æ–°ç”¨æˆ·æ³¨å†Œç¦åˆ© (3æ¬¡å…è´¹ç”Ÿæˆ)', 
    NOW()
  );

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ==========================================
-- æ­¥éª¤ 2: å‡çº§ IP é€Ÿç‡é™åˆ¶ (é˜²ç¾Šæ¯›å…šæ ¸å¿ƒ)
-- ==========================================
-- é€»è¾‘ï¼šå…è®¸æ¯ä¸ª IP æ¯å¤©æ¶ˆè€— "ç›¸å½“äº 2 ä¸ªæ–°ç”¨æˆ·" çš„é¢åº¦ (ä¾‹å¦‚ 6 æ¬¡ç”Ÿæˆ)
-- æ­£å¸¸ç”¨æˆ·å®¶é‡Œæœ€å¤šä¹Ÿå°± 2-3 ä¸ªäººæ³¨å†Œï¼Œä¸ä¼šè§¦å‘é™åˆ¶ã€‚
-- ç¾Šæ¯›å…šè„šæœ¬ä¸€ä¸ª IP æ³¨å†Œ 100 ä¸ªå·ï¼Œç¬¬ 3 ä¸ªå·å¼€å§‹å°±ä¼šè¢«å¡æ­»ã€‚

CREATE OR REPLACE FUNCTION public.check_ip_rate_limit(client_ip text)
RETURNS boolean AS $$
DECLARE
    limit_record public.ip_usage_logs%rowtype;
    -- ğŸŸ¢ é™åˆ¶é˜ˆå€¼ï¼šæ¯å¤©å…è®¸ 6 æ¬¡ç”Ÿæˆè¯·æ±‚ (30ç§¯åˆ†=3æ¬¡ï¼Œè¿™é‡Œç»™ 2 ä¸ªäººçš„å®½é™)
    max_generations constant integer := 6; 
BEGIN
    -- æŸ¥è¯¢è¯¥ IP ä»Šå¤©çš„è®°å½•
    SELECT * INTO limit_record 
    FROM public.ip_usage_logs 
    WHERE client_ip = check_ip_rate_limit.client_ip 
    AND usage_date = CURRENT_DATE;
    
    IF NOT FOUND THEN
        -- å¦‚æœä»Šå¤©æ²¡è®°å½•ï¼Œæ’å…¥ä¸€æ¡ï¼Œè®¡æ•°ä¸º 1ï¼Œå…è®¸é€šè¿‡
        INSERT INTO public.ip_usage_logs (client_ip, usage_date, generation_count, last_generation_at)
        VALUES (check_ip_rate_limit.client_ip, CURRENT_DATE, 1, NOW());
        RETURN true;
    ELSE
        -- å¦‚æœæœ‰è®°å½•ï¼Œæ£€æŸ¥æ¬¡æ•°
        IF limit_record.generation_count < max_generations THEN
            -- æœªè¶…é™ï¼Œè®¡æ•°+1ï¼Œå…è®¸é€šè¿‡
            UPDATE public.ip_usage_logs 
            SET generation_count = generation_count + 1, 
                last_generation_at = NOW(),
                updated_at = NOW()
            WHERE id = limit_record.id;
            RETURN true;
        ELSE
            -- ğŸ”´ è¶…é™ï¼Œæ‹’ç»é€šè¿‡
            RETURN false;
        END IF;
    END IF;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
